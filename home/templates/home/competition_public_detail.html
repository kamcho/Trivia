{% extends 'home/competition/base.html' %}

{% block breadcrumb %}
<li class="flex items-center">
    <i class="fas fa-angle-right text-gray-500 mx-2"></i>
    <a href="{% url 'competition_list' %}" class="text-sm font-medium text-gray-400 hover:text-white transition-colors">Competitions</a>
</li>
<li class="flex items-center">
    <i class="fas fa-angle-right text-gray-500 mx-2"></i>
    <span class="text-sm font-medium text-gray-400">{{ competition.name|truncatechars:40 }}</span>
</li>
{% endblock %}

{% block header_title %}{{ competition.name }}{% endblock %}
{% block header_subtitle %}
    {% if competition.description %}{{ competition.description|truncatechars:140 }}{% else %}Competition details{% endif %}
{% endblock %}

{% block header_actions %}
<a href="{% url 'competition_list' %}"
   class="inline-flex items-center px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-semibold transition-colors">
    <i class="fas fa-arrow-left mr-2"></i> Back to List
</a>
<a href="{% url 'competition_booking' slug=competition.slug %}"
   class="inline-flex items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-semibold transition-colors ml-2">
    <i class="fas fa-ticket-alt mr-2"></i> Book Now 🎟️
</a>
{% endblock %}

{% block competition_content %}
<div class="w-full overflow-x-auto -mt-2 mb-4">
    <nav class="inline-flex gap-2 text-xs whitespace-nowrap align-middle">
        <a href="#overview" class="px-3 py-1.5 rounded-full bg-slate-700/50 text-slate-200 hover:bg-slate-600/60">🧾 Overview</a>
        {% if intro_media %}{# less critical, moved to More #}{% endif %}
        {% if eligibility %}{# less critical, moved to More #}{% endif %}
        <a href="#activities" class="px-3 py-1.5 rounded-full bg-slate-700/50 text-slate-200 hover:bg-slate-600/60">🧩 Activities</a>
        {% if registration_windows %}<a href="#registration" class="px-3 py-1.5 rounded-full bg-slate-700/50 text-slate-200 hover:bg-slate-600/60">🪪 Registration</a>{% endif %}
        {% if schedule_items %}<a href="#schedule" class="px-3 py-1.5 rounded-full bg-slate-700/50 text-slate-200 hover:bg-slate-600/60">🗓️ Schedule</a>{% endif %}
        {% if gallery_media %}<a href="#gallery" class="px-3 py-1.5 rounded-full bg-slate-700/50 text-slate-200 hover:bg-slate-600/60">📸 Gallery</a>{% endif %}
        {% if contacts %}<a href="#contacts" class="px-3 py-1.5 rounded-full bg-slate-700/50 text-slate-200 hover:bg-slate-600/60">📇 Contacts</a>{% endif %}

        <details class="inline-block">
            <summary class="list-none inline-flex items-center px-3 py-1.5 rounded-full bg-slate-800/50 text-slate-300 hover:bg-slate-700/60 cursor-pointer select-none">
                <span class="mr-1">⋯</span> More
            </summary>
            <div class="mt-2 inline-flex gap-2 align-middle">
                {% if intro_media %}<a href="#intro" class="px-3 py-1.5 rounded-full bg-slate-700/50 text-slate-200 hover:bg-slate-600/60">▶️ Intro</a>{% endif %}
                {% if eligibility %}<a href="#eligibility" class="px-3 py-1.5 rounded-full bg-slate-700/50 text-slate-200 hover:bg-slate-600/60">✅ Eligibility</a>{% endif %}
                {% if resources %}<a href="#resources" class="px-3 py-1.5 rounded-full bg-slate-700/50 text-slate-200 hover:bg-slate-600/60">📄 Resources</a>{% endif %}
                {% if sponsors %}<a href="#sponsors" class="px-3 py-1.5 rounded-full bg-slate-700/50 text-slate-200 hover:bg-slate-600/60">🤝 Sponsors</a>{% endif %}
                {% if venues %}<a href="#venue" class="px-3 py-1.5 rounded-full bg-slate-700/50 text-slate-200 hover:bg-slate-600/60">📍 Venue</a>{% endif %}
                {% if social_links %}<a href="#follow" class="px-3 py-1.5 rounded-full bg-slate-700/50 text-slate-200 hover:bg-slate-600/60">🔗 Follow</a>{% endif %}
                <a href="#meta" class="px-3 py-1.5 rounded-full bg-slate-700/50 text-slate-200 hover:bg-slate-600/60">ℹ️ Meta</a>
            </div>
        </details>
    </nav>
</div>
<div class="grid grid-cols-1 gap-6">
    {% if intro_media %}
    <div id="intro" class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
            <span class="mr-2">▶️</span>
            Introduction
        </h3>
        {% include 'home/partials/_competition_media_item.html' with item=intro_media %}
    </div>
    {% endif %}

    <div id="overview" class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-slate-700/50">
        <div class="flex flex-wrap items-center gap-2 mb-4">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-700/50 text-slate-300">
                🏷️ {{ competition.get_status_display }}
            </span>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-700/50 text-slate-300">
                📅 {{ competition.start_date|date:"M d, Y" }} — {{ competition.end_date|date:"M d, Y" }}
            </span>
        </div>
        {% if competition.description %}
        <p class="text-gray-300">🧠 {{ competition.description }}</p>
        {% endif %}
    </div>

    {% if eligibility %}
    <div id="eligibility" class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
            <span class="mr-2">✅</span>
            Eligibility
        </h3>
        <div class="space-y-3 text-sm">
            <div class="flex flex-wrap gap-2 items-center">
                <span class="text-gray-400">🎯 Levels:</span>
                {% if eligibility.allowed_levels and 'All' not in eligibility.allowed_levels %}
                    {% for lvl in eligibility.allowed_levels %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full bg-slate-700/50 text-slate-200 border border-slate-700/60">{{ lvl }}</span>
                    {% endfor %}
                {% else %}
                    <span class="text-slate-200">All</span>
                {% endif %}
            </div>
            <div class="flex flex-wrap gap-2 items-center">
                <span class="text-gray-400">👥 Participation:</span>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full bg-slate-700/50 text-slate-200 border border-slate-700/60">{{ eligibility.allowed_participation }}</span>
            </div>
            {% if eligibility.min_age or eligibility.max_age %}
            <div class="flex flex-wrap gap-2 items-center">
                <span class="text-gray-400">🎂 Age:</span>
                <span class="text-slate-200">{{ eligibility.min_age|default:'-' }} - {{ eligibility.max_age|default:'-' }}</span>
            </div>
            {% endif %}
        </div>
        {% if eligibility.prerequisites %}
        <div class="mt-4 text-sm text-gray-300">
            <div class="text-gray-400 mb-1">📝 Prerequisites</div>
            <p>{{ eligibility.prerequisites }}</p>
        </div>
        {% endif %}
        {% if eligibility.eligibility_notes %}
        <div class="mt-4 text-sm text-gray-300">
            <div class="text-gray-400 mb-1">💡 Notes</div>
            <p>{{ eligibility.eligibility_notes }}</p>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div id="activities" class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
            <span class="mr-2">🧩</span>
            Activities
        </h3>
        {% if competition.activities.all %}
        <ul class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {% for activity in competition.activities.all %}
            <li class="bg-slate-800/30 rounded-lg p-3 border border-slate-700/50">
                <div class="flex items-start justify-between">
                    {% if activity.slug %}
                    <a href="{% url 'competitionactivity_detail' slug=activity.slug %}" class="text-white font-medium hover:text-indigo-300">
                        {{ activity.name }}
                    </a>
                    {% else %}
                    <span class="text-white font-medium">{{ activity.name }}</span>
                    {% endif %}
                    <span class="text-xs text-gray-400 self-center">{{ activity.get_activity_type_display|default:'Activity' }}</span>
                </div>
                {% if activity.description %}
                <p class="text-sm text-gray-400 mt-1">{{ activity.description|truncatechars:160 }}</p>
                {% endif %}
                {% if activity.slug %}
                <div class="mt-3 flex justify-end">
                    <a href="{% url 'competitionactivity_detail' slug=activity.slug %}#instructions"
                       class="inline-flex items-center px-3 py-1.5 rounded-md text-xs font-medium bg-indigo-600 hover:bg-indigo-500 text-white transition-colors">
                        <i class="fas fa-eye mr-1"></i>
                        View activity
                    </a>
                </div>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-gray-400">No activities linked yet.</p>
        {% endif %}
    </div>

    {% if registration_windows %}
    <div id="registration" class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
            <span class="mr-2">🪪</span>
            Registration
        </h3>
        <div class="space-y-3 text-sm">
            {% for w in registration_windows %}
            <div class="flex items-center justify-between bg-slate-800/30 rounded-lg p-3 border border-slate-700/50">
                <div class="text-gray-300">
                    <i class="far fa-clock mr-1"></i>
                    {{ w.opens_at|date:"M d, Y H:i" }} → {{ w.closes_at|date:"M d, Y H:i" }}
                    {% if w.capacity %}<span class="ml-2 text-xs text-gray-400">Capacity: {{ w.capacity }}</span>{% endif %}
                </div>
                {% if w.fee_amount %}
                <div class="text-indigo-300 font-medium">{{ w.fee_currency }} {{ w.fee_amount }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if schedule_items %}
    <div id="schedule" class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
            <span class="mr-2">🗓️</span>
            Schedule
        </h3>
        <div class="space-y-3 text-sm">
            {% for it in schedule_items %}
            <div class="bg-slate-800/30 rounded-lg p-3 border border-slate-700/50">
                <div class="flex items-center justify-between">
                    <div class="text-white font-medium">{{ it.title }}</div>
                    <div class="text-gray-300"><i class="far fa-clock mr-1"></i>{{ it.start_at|date:"M d, Y H:i" }}{% if it.end_at %} — {{ it.end_at|date:"M d, Y H:i" }}{% endif %}</div>
                </div>
                {% if it.location_hint %}<div class="text-xs text-gray-400 mt-1">{{ it.location_hint }}</div>{% endif %}
                {% if it.description %}<div class="text-sm text-gray-300 mt-2">{{ it.description }}</div>{% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if resources %}
    <div id="resources" class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4">📄 Resources</h3>
        <ul class="space-y-2 text-sm">
            {% for r in resources %}
            <li class="flex items-center justify-between bg-slate-800/30 rounded-lg p-3 border border-slate-700/50">
                <div class="text-white font-medium">{{ r.title }}</div>
                {% if r.file %}
                <a href="{{ r.file.url }}" class="text-indigo-300 hover:text-indigo-200" target="_blank"><i class="fas fa-download mr-1"></i>Download</a>
                {% elif r.url %}
                <a href="{{ r.url }}" class="text-indigo-300 hover:text-indigo-200" target="_blank"><i class="fas fa-external-link-alt mr-1"></i>Open</a>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if sponsors %}
    <div id="sponsors" class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
            <span class="mr-2">🤝</span>
            Sponsors
        </h3>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            {% for s in sponsors %}
            <div class="bg-slate-800/30 rounded-lg p-3 border border-slate-700/50 flex items-center gap-3">
                {% if s.logo %}
                    {% if s.website %}<a href="{{ s.website }}" target="_blank" class="shrink-0">{% endif %}
                    <img src="{{ s.logo.url }}" class="h-10 w-10 object-cover rounded" alt="{{ s.name }}">
                    {% if s.website %}</a>{% endif %}
                {% endif %}
                <div class="min-w-0">
                    <div class="text-white text-sm font-medium truncate">
                        {% if s.website %}<a href="{{ s.website }}" target="_blank" class="hover:text-indigo-300">{{ s.name }}</a>{% else %}{{ s.name }}{% endif %}
                    </div>
                    <div class="text-xs text-gray-400 truncate">{{ s.get_tier_display }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if gallery_media %}
    <div id="gallery" class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
            <span class="mr-2">📸</span>
            Gallery
        </h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {% for item in gallery_media %}
                {% include 'home/partials/_competition_media_item.html' with item=item %}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if venues %}
    <div id="venue" class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
            <span class="mr-2">📍</span>
            Venue
        </h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {% for v in venues %}
            <div class="rounded-lg border border-slate-700/50 bg-slate-900/40 p-4">
                <div class="text-white font-medium text-sm">{{ v.name }}</div>
                <div class="mt-2 space-y-1 text-sm text-gray-300">
                    {% if v.address %}
                    <div class="flex items-center gap-2">
                        <i class="fas fa-location-dot text-slate-400"></i>
                        <span class="truncate">{{ v.address }}</span>
                    </div>
                    {% endif %}
                    <div class="flex items-center gap-2">
                        <i class="fas fa-city text-slate-400"></i>
                        <span class="truncate">{{ v.city }}{% if v.city and v.country %}, {% endif %}{{ v.country }}</span>
                    </div>
                    {% if v.room %}
                    <div class="flex items-center gap-2">
                        <i class="fas fa-door-open text-slate-400"></i>
                        <span class="truncate">Room: {{ v.room }}</span>
                    </div>
                    {% endif %}
                </div>
                <div class="mt-3 flex items-center justify-between text-xs text-slate-400">
                    {% if v.map_link %}
                    <a href="{{ v.map_link }}" target="_blank" class="inline-flex items-center px-3 py-1.5 rounded-md bg-slate-800/60 hover:bg-slate-700/60 border border-slate-700/60 text-slate-200">
                        <i class="fas fa-location-arrow mr-2"></i>Open Map
                    </a>
                    {% endif %}
                    {% if v.latitude and v.longitude %}
                    <span>GPS: {{ v.latitude }}, {{ v.longitude }}</span>
                    {% endif %}
                </div>
                {% if v.notes %}
                <div class="mt-3 text-xs text-slate-400">{{ v.notes }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if contacts %}
    <div id="contacts" class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
            <span class="mr-2">📇</span>
            Contacts
        </h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {% for c in contacts %}
            <div class="rounded-lg border border-slate-700/50 bg-slate-900/40 p-4">
                <div class="flex items-start justify-between">
                    <div class="min-w-0">
                        <div class="text-white font-medium text-sm truncate">
                            {{ c.name }}
                            {% if c.is_primary %}
                            <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-green-900/30 text-green-300 border border-green-700/30">Primary</span>
                            {% endif %}
                        </div>
                        <div class="text-xs text-gray-400">{{ c.get_role_display }}</div>
                    </div>
                    <div class="text-[11px] text-gray-300 whitespace-nowrap ml-3">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-slate-800/60 border border-slate-700/60">{{ c.get_preferred_channel_display }}</span>
                    </div>
                </div>
                <div class="mt-3 space-y-1 text-sm text-gray-300">
                    {% if c.phone %}
                    <div class="flex items-center gap-2">
                        <i class="fas fa-phone text-slate-400"></i>
                        <a href="tel:{{ c.phone }}" class="hover:text-indigo-300">{{ c.phone }}</a>
                    </div>
                    {% endif %}
                    {% if c.email %}
                    <div class="flex items-center gap-2">
                        <i class="far fa-envelope text-slate-400"></i>
                        <a href="mailto:{{ c.email }}" class="hover:text-indigo-300">{{ c.email }}</a>
                    </div>
                    {% endif %}
                </div>
                {% if c.notes %}
                <div class="mt-3 text-xs text-slate-400">{{ c.notes }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if social_links %}
    <div id="follow" class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4">🔗 Follow</h3>
        <div class="flex flex-wrap gap-2">
            {% for sl in social_links %}
            <a href="{{ sl.url }}" target="_blank" class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium bg-slate-700/50 text-slate-300 hover:bg-slate-600/50 transition-colors">{{ sl.display_name|default:sl.network }}</a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div id="meta" class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-slate-700/50">
        <h3 class="text-lg font-semibold text-white mb-4">ℹ️ Meta</h3>
        <div class="space-y-3 text-sm">
            <div class="flex items-center justify-between">
                <span class="text-gray-300">Status</span>
                <span class="text-slate-200">{{ competition.get_status_display }}</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-gray-300">Active</span>
                <span class="text-slate-200">{% if competition.is_active %}Yes{% else %}No{% endif %}</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-gray-300">Activities</span>
                <span class="text-slate-200">{{ competition.activities.count }}</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}



