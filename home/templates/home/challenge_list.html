{% extends "base.html" %}
{% load static %}

{% block title %}Challenges · BibleTrivia{% endblock %}

{% block content %}
<section class="py-10">
  <div class="max-w-6xl mx-auto">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold text-slate-100">Your Challenges</h1>
      <a href="{% url 'challenge_create' %}" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 rounded-md text-sm">New Challenge</a>
    </div>

    <form method="get" class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-3">
      <input type="text" name="q" value="{{ search_query }}" placeholder="Search by name or description" class="w-full rounded-md bg-slate-900/60 border border-slate-700/50 px-3 py-2 text-sm text-slate-200 placeholder-slate-400">
      <select name="status" class="w-full rounded-md bg-slate-900/60 border border-slate-700/50 px-3 py-2 text-sm text-slate-200">
        <option value="">All statuses</option>
        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
        <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
        <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
        <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
      </select>
      <select name="mode" class="w-full rounded-md bg-slate-900/60 border border-slate-700/50 px-3 py-2 text-sm text-slate-200">
        <option value="">All modes</option>
        <option value="individual" {% if mode_filter == 'individual' %}selected{% endif %}>Individual</option>
        <option value="group" {% if mode_filter == 'group' %}selected{% endif %}>Group</option>
      </select>
      <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-2 rounded-md text-sm">Filter</button>
    </form>

    {% if challenges %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for ch in challenges %}
      <a href="{% url 'challenge_detail' ch.pk %}" class="block rounded-xl border border-slate-700/50 bg-slate-800/50 p-5 hover:bg-slate-800/70 shadow-sm hover:shadow-md transition group">
        <div class="flex items-start justify-between gap-5">
          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-3 mb-1.5">
              <span class="text-slate-100 font-semibold group-hover:underline truncate">
                {% if ch.name %}{{ ch.name }}{% else %}Challenge #{{ ch.id }}{% endif %}
              </span>
              <span class="text-[11px] px-2 py-0.5 rounded-full border border-slate-600 text-slate-300 whitespace-nowrap">{{ ch.rounds.count|default:0 }} rounds</span>
            </div>
            <div class="mt-1 text-slate-400 text-sm flex items-center gap-2 flex-wrap">
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px]
                {% if ch.mode == 'group' %} bg-cyan-600/20 text-cyan-300 border border-cyan-600/40 {% else %} bg-emerald-600/20 text-emerald-300 border border-emerald-600/40 {% endif %}">
                {% if ch.mode == 'group' %}Group{% else %}Individual{% endif %}
              </span>
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px]
                {% if ch.status == 'active' %} bg-emerald-600/20 text-emerald-300 border border-emerald-600/40
                {% elif ch.status == 'pending' %} bg-amber-600/20 text-amber-300 border border-amber-600/40
                {% elif ch.status == 'completed' %} bg-indigo-600/20 text-indigo-300 border border-indigo-600/40
                {% elif ch.status == 'cancelled' %} bg-rose-600/20 text-rose-300 border border-rose-600/40
                {% elif ch.status == 'expired' %} bg-slate-600/20 text-slate-300 border border-slate-600/40
                {% else %} bg-slate-700/30 text-slate-300 border border-slate-600/40 {% endif %}">
                {{ ch.status|title }}
              </span>
              <span class="inline-flex items-center gap-1 text-slate-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v6l3 3"/></svg> Best of {{ ch.best_of|default:1 }}</span>
              <span class="inline-flex items-center gap-1 text-slate-400">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V5m8 2V5M3 9h18M5 9v10a2 2 0 002 2h10a2 2 0 002-2V9"/></svg>
                {% if ch.scheduled_at %}{{ ch.scheduled_at|date:"M j, Y H:i" }}{% else %}<span class="italic">Not scheduled</span>{% endif %}
              </span>
              <span class="inline-flex items-center gap-1 text-slate-400">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3"/></svg>
                {% if ch.expires_at %}Expires {{ ch.expires_at|date:"M j, Y H:i" }}{% else %}<span class="italic">No expiry</span>{% endif %}
              </span>
            </div>
            <p class="mt-3 text-slate-300 text-base min-h-[1.5rem]">{{ ch.description|default:"-" }}</p>

            <!-- Rounds setup progress -->
            <div class="mt-4 flex items-center gap-1.5">
              {% for r in ch.rounds.all %}
                <span class="w-3 h-3 rounded-full inline-block {% if r.quiz %} bg-emerald-500 {% else %} bg-slate-600 {% endif %}"></span>
              {% empty %}
                <span class="text-xs text-slate-400">No rounds yet</span>
              {% endfor %}
            </div>

            <!-- Participants preview -->
            <div class="mt-4 flex items-center gap-2.5 flex-wrap">
              {% with total=ch.participants.count %}
                {% if total > 0 %}
                  {% for p in ch.participants.all|slice:":3" %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full bg-slate-700/40 text-slate-200 text-sm">
                      {% if p.user %}{{ p.user.get_full_name|default:p.user.username }}{% else %}{{ p.group.name }}{% endif %}
                      {% if not p.is_active %}<span class="ml-1 text-amber-300">(pending)</span>{% endif %}
                    </span>
                  {% endfor %}
                  {% if total > 3 %}
                    <span class="text-sm text-slate-400">+{{ total|add:"-3" }} more</span>
                  {% endif %}
                {% else %}
                  <span class="text-sm text-slate-400">No participants yet</span>
                {% endif %}
              {% endwith %}
            </div>
          </div>
          <!-- Creator badge -->
          <div class="shrink-0">
            <div class="w-10 h-10 rounded-full bg-slate-700/60 grid place-items-center text-sm text-slate-200">
              {% with n=ch.created_by.get_full_name|default:ch.created_by.username %}
                {{ n|default:"U"|slice:":1"|upper }}
              {% endwith %}
            </div>
          </div>
        </div>
        <div class="mt-5 flex items-center justify-between text-base">
          <div class="flex items-center gap-4 text-slate-400">
            <span class="inline-flex items-center gap-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5V4H2v16h5m10 0V10l-4 3-4-3v10"/></svg> {{ ch.participants.count|default:0 }} participants</span>
            <span class="inline-flex items-center gap-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2"/></svg> {{ ch.created_at|date:"M j, Y"|default:"—" }}</span>
          </div>
          <div class="flex items-center gap-2 text-slate-400">
            <span class="inline-flex items-center gap-1 opacity-70 group-hover:opacity-100">Open <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5l7 7-7 7"/></svg></span>
          </div>
        </div>
      </a>
      {% endfor %}
    </div>
    {% else %}
    <div class="py-16 flex flex-col items-center justify-center text-slate-400">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-12 h-12 mb-3 text-slate-500">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <p class="text-sm">No challenges found. Create one to get started.</p>
      <a href="{% url 'challenge_create' %}" class="mt-3 inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 rounded-md text-sm">
        New Challenge
      </a>
    </div>
    {% endif %}

    {% if is_paginated %}
    <div class="mt-6 flex items-center justify-between text-slate-400 text-sm">
      <div>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</div>
      <div class="space-x-2">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}&q={{ search_query }}&status={{ status_filter }}&mode={{ mode_filter }}" class="px-2 py-1 rounded-md border border-slate-700/50 hover:bg-slate-800/60">Prev</a>
        {% endif %}
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}&q={{ search_query }}&status={{ status_filter }}&mode={{ mode_filter }}" class="px-2 py-1 rounded-md border border-slate-700/50 hover:bg-slate-800/60">Next</a>
        {% endif %}
      </div>
    </div>
    {% endif %}

  </div>
</section>
{% endblock %}


